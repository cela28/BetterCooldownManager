---
phase: 01-settings-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Core/Defaults.lua
  - Core/Globals.lua
autonomous: true

must_haves:
  truths:
    - "HideWhenOffCooldown setting persists across /reload"
    - "Each bar type (Essential, Utility, Buffs) has independent setting"
    - "Setting defaults to false (feature disabled by default)"
    - "Getter/setter functions return correct values"
  artifacts:
    - path: "Core/Defaults.lua"
      provides: "HideWhenOffCooldown default value for each bar"
      contains: "HideWhenOffCooldown = false"
    - path: "Core/Globals.lua"
      provides: "API functions for setting access"
      exports: ["BCDM:GetHideWhenOffCooldown", "BCDM:SetHideWhenOffCooldown", "BCDM:IsHideWhenOffCooldownEnabled"]
  key_links:
    - from: "Core/Globals.lua"
      to: "BCDM.db.profile.CooldownManager"
      via: "getter/setter functions"
      pattern: "BCDM\\.db\\.profile\\.CooldownManager\\[barType\\]"
---

<objective>
Add the HideWhenOffCooldown per-bar setting to the addon's settings infrastructure.

Purpose: This setting is the foundation for the "hide spells when off cooldown" feature. Without it, no other phase can store or retrieve the user's preference.

Output: HideWhenOffCooldown field in Defaults.lua for Essential/Utility/Buffs bars, plus getter/setter functions in Globals.lua for clean API access.
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-settings-infrastructure/01-RESEARCH.md
@Core/Defaults.lua
@Core/Globals.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HideWhenOffCooldown to Defaults.lua</name>
  <files>Core/Defaults.lua</files>
  <action>
Add `HideWhenOffCooldown = false` to THREE bar types in the CooldownManager section of Defaults.lua:

1. **Essential** (around line 128, after CenterHorizontally):
```lua
CenterHorizontally = false,
HideWhenOffCooldown = false,  -- NEW: Hide icons when spell is off cooldown
```

2. **Utility** (around line 141, after CenterHorizontally):
```lua
CenterHorizontally = false,
HideWhenOffCooldown = false,  -- NEW: Hide icons when spell is off cooldown
```

3. **Buffs** (around line 154, after CenterBuffs):
```lua
CenterBuffs = false,
HideWhenOffCooldown = false,  -- NEW: Hide icons when spell is off cooldown
```

Follow the existing PascalCase convention. Place the new field after the CenterHorizontally/CenterBuffs field for consistency with similar per-bar boolean settings.

Do NOT add to Custom, AdditionalCustom, Item, Trinket, ItemSpell, or BuffBar - those have different structures and will be handled in future phases if requested.
  </action>
  <verify>
Grep for HideWhenOffCooldown in Defaults.lua - should find exactly 3 occurrences (Essential, Utility, Buffs).
```bash
grep -c "HideWhenOffCooldown" Core/Defaults.lua
# Expected: 3
grep -n "HideWhenOffCooldown" Core/Defaults.lua
# Expected: Shows lines in Essential, Utility, and Buffs sections
```
  </verify>
  <done>
HideWhenOffCooldown = false appears in Essential, Utility, and Buffs sections of Defaults.lua. AceDB will automatically provide SavedVariables persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getter/setter functions to Globals.lua</name>
  <files>Core/Globals.lua</files>
  <action>
Add three functions to the END of Core/Globals.lua (before any closing statements, but after the existing BCDM.AnchorParents table):

```lua
-- HideWhenOffCooldown Setting API
-- These functions provide a clean interface for other modules to access the per-bar setting

function BCDM:GetHideWhenOffCooldown(barType)
    if not barType then return false end
    local barSettings = self.db.profile.CooldownManager[barType]
    return barSettings and barSettings.HideWhenOffCooldown or false
end

function BCDM:SetHideWhenOffCooldown(barType, value)
    if not barType then return end
    local barSettings = self.db.profile.CooldownManager[barType]
    if barSettings then
        barSettings.HideWhenOffCooldown = value
        -- Future phases may add refresh/update calls here
    end
end

-- Helper: Check setting by viewer frame name (e.g., "EssentialCooldownViewer")
function BCDM:IsHideWhenOffCooldownEnabled(viewerFrameName)
    local barType = self.CooldownManagerViewerToDBViewer[viewerFrameName]
    return self:GetHideWhenOffCooldown(barType)
end
```

These functions:
- Use `self` (not `BCDM`) since they're methods on the BCDM table
- Return false as default if barType is nil or setting doesn't exist (defensive)
- Use the existing `CooldownManagerViewerToDBViewer` mapping table (defined in Globals.lua line 9-13)
- Follow the existing code style (no explicit `return nil`, use `or false` for safety)
  </action>
  <verify>
1. Check functions exist:
```bash
grep -n "GetHideWhenOffCooldown\|SetHideWhenOffCooldown\|IsHideWhenOffCooldownEnabled" Core/Globals.lua
# Expected: 3 function definitions
```

2. Check functions use proper pattern:
```bash
grep "CooldownManager\[barType\]" Core/Globals.lua
# Expected: At least 2 matches (getter and setter)
```
  </verify>
  <done>
Three functions exist in Globals.lua:
- BCDM:GetHideWhenOffCooldown(barType) returns boolean
- BCDM:SetHideWhenOffCooldown(barType, value) stores boolean
- BCDM:IsHideWhenOffCooldownEnabled(viewerFrameName) returns boolean via viewer name lookup
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Defaults structure check:**
```bash
grep -A2 "Essential = {" Core/Defaults.lua | head -10
grep -A2 "Utility = {" Core/Defaults.lua | head -10
grep -A2 "Buffs = {" Core/Defaults.lua | head -10
```
Each should show HideWhenOffCooldown in the section.

2. **Functions available check:**
```bash
grep "function BCDM:" Core/Globals.lua | grep -i hide
```
Should show the three new functions.

3. **No syntax errors:**
The addon should load without Lua errors. This can be verified by loading WoW with the addon enabled (manual verification in-game, not part of automated checks).
</verification>

<success_criteria>
- [ ] HideWhenOffCooldown = false exists in Essential section of Defaults.lua
- [ ] HideWhenOffCooldown = false exists in Utility section of Defaults.lua
- [ ] HideWhenOffCooldown = false exists in Buffs section of Defaults.lua
- [ ] BCDM:GetHideWhenOffCooldown(barType) function exists in Globals.lua
- [ ] BCDM:SetHideWhenOffCooldown(barType, value) function exists in Globals.lua
- [ ] BCDM:IsHideWhenOffCooldownEnabled(viewerFrameName) function exists in Globals.lua
- [ ] All grep verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-settings-infrastructure/01-01-SUMMARY.md`
</output>
