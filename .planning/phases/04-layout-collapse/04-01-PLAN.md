---
phase: 04-layout-collapse
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Modules/CooldownManager.lua]
autonomous: true

must_haves:
  truths:
    - "When HideWhenOffCooldown is enabled, visible icons shift to fill gaps left by hidden (alpha=0) icons"
    - "Icons compact toward the center of the bar, not left-aligned"
    - "Multi-row bars reflow across rows â€” if row 1 loses icons, row 2 icons move up"
    - "When a hidden icon reappears, it returns to its original configured position"
    - "Bar container keeps its original dimensions (no shrinking)"
    - "When all icons are hidden, the empty bar frame stays visible"
    - "Layout collapse only activates when HideWhenOffCooldown is enabled for that bar"
  artifacts:
    - path: "Modules/CooldownManager.lua"
      provides: "Modified CenterWrappedRows with alpha filtering"
      contains: "GetAlpha"
  key_links:
    - from: "Modules/CooldownManager.lua"
      to: "BCDM:IsHideWhenOffCooldownEnabled"
      via: "Feature toggle guard in CenterWrappedRows"
      pattern: "IsHideWhenOffCooldownEnabled.*viewerName"
    - from: "Modules/CooldownManager.lua"
      to: "Modules/HideWhenOffCooldown.lua"
      via: "Alpha=0 icons excluded from layout by GetAlpha check"
      pattern: "GetAlpha.*>.*0"
---

<objective>
Add alpha-based filtering to CenterWrappedRows so that hidden icons (alpha=0) are excluded from layout calculation, causing remaining visible icons to shift and fill gaps.

Purpose: This is the core layout collapse behavior -- Phase 3 hides icons by setting alpha=0 but they still occupy space. This modification makes them truly "collapse" by excluding them from position calculations.

Output: Modified CenterWrappedRows function in CooldownManager.lua that filters icons by alpha when the HideWhenOffCooldown feature is enabled.
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-layout-collapse/04-RESEARCH.md
@.planning/phases/03-alpha-based-hiding/03-01-SUMMARY.md
@Modules/CooldownManager.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alpha filtering to CenterWrappedRows</name>
  <files>Modules/CooldownManager.lua</files>
  <action>
Modify the `CenterWrappedRows` function (lines 220-271) to filter out alpha=0 icons when the HideWhenOffCooldown feature is enabled for the given viewer.

Specifically, in the icon collection loop (lines 227-232), add two changes:

1. Before the loop, check if the feature is enabled for this viewer:
   ```lua
   local collapseEnabled = BCDM:IsHideWhenOffCooldownEnabled(viewerName)
   ```

2. In the filtering condition (line 229), add an alpha check guarded by the feature toggle:
   ```lua
   if childFrame and childFrame:IsShown() and childFrame.layoutIndex then
       if not collapseEnabled or childFrame:GetAlpha() > 0 then
           table.insert(visibleIcons, childFrame)
       end
   end
   ```

This keeps existing behavior unchanged when the feature is disabled (all shown icons with layoutIndex are included). When enabled, icons with alpha=0 are excluded from the visibleIcons list, causing the existing centering/wrapping math to reflow around only visible icons.

DO NOT:
- Create a new layout function (modify the existing CenterWrappedRows, not duplicate it)
- Modify layoutIndex values (these preserve configured icon order)
- Cache the visible icons list (must recalculate every RefreshLayout call)
- Use GetAlpha() == 1 (use > 0 to avoid issues with intermediate alpha values)
- Change any of the centering math, row wrapping, or SetPoint logic -- only the filtering

The existing early return on `visibleCount == 0` (line 237) already handles the "all icons hidden" edge case correctly -- the bar frame stays visible but no icons are repositioned.

The existing `table.sort` by layoutIndex (line 234) ensures icons return to their original configured position when they become visible again.
  </action>
  <verify>
Read back CooldownManager.lua and confirm:
1. CenterWrappedRows calls BCDM:IsHideWhenOffCooldownEnabled(viewerName)
2. The icon collection loop checks GetAlpha() > 0 when collapse is enabled
3. The guard uses `not collapseEnabled or childFrame:GetAlpha() > 0` pattern (so when feature is off, all shown icons are included)
4. No other changes to CenterWrappedRows beyond the filtering addition
5. The rest of the file is unchanged
  </verify>
  <done>CenterWrappedRows filters out alpha=0 icons when HideWhenOffCooldown is enabled, causing visible icons to reflow and fill gaps. Feature toggle guard ensures no behavior change when disabled.</done>
</task>

</tasks>

<verification>
1. Read Modules/CooldownManager.lua and verify the CenterWrappedRows modification
2. Confirm BCDM:IsHideWhenOffCooldownEnabled is called with viewerName parameter
3. Confirm GetAlpha() > 0 check is present and guarded by collapseEnabled
4. Confirm no other functions or files were modified
5. Confirm the centering math (startX = -rowWidth / 2 + iconWidth / 2) is unchanged
6. Confirm the sort by layoutIndex is unchanged
7. Confirm the early return on visibleCount == 0 is unchanged
</verification>

<success_criteria>
- CenterWrappedRows excludes alpha=0 icons from layout when HideWhenOffCooldown is enabled
- CenterWrappedRows behaves identically to before when HideWhenOffCooldown is disabled
- Icons compact toward center using existing centering math
- Multi-row bars reflow correctly (icons wrap based on visible count, not total count)
- Empty state (all hidden) returns early without error
- Icon order preserved via layoutIndex sorting
</success_criteria>

<output>
After completion, create `.planning/phases/04-layout-collapse/04-01-SUMMARY.md`
</output>
