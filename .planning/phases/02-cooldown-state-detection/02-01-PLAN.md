---
phase: 02-cooldown-state-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Core/Globals.lua
autonomous: true

must_haves:
  truths:
    - "IsSpellOnCooldown returns true when a spell has a real cooldown active"
    - "IsSpellOnCooldown returns false when a spell is only on GCD"
    - "IsSpellOnCooldown returns true for charge spells with any charge recharging"
    - "IsSpellOnCooldown returns false for charge spells at max charges"
    - "IsSpellOnCooldown returns false (fail-show) on invalid spell IDs or API errors"
  artifacts:
    - path: "Core/Globals.lua"
      provides: "BCDM:IsSpellOnCooldown(spellID) function"
      exports: ["BCDM:IsSpellOnCooldown"]
      contains: "function BCDM:IsSpellOnCooldown"
  key_links:
    - from: "Core/Globals.lua"
      to: "C_Spell.GetSpellCooldown"
      via: "WoW API call for cooldown info"
      pattern: "C_Spell.GetSpellCooldown"
    - from: "Core/Globals.lua"
      to: "C_Spell.GetSpellCharges"
      via: "WoW API call for charge spell detection"
      pattern: "C_Spell.GetSpellCharges"
---

<objective>
Create the IsSpellOnCooldown(spellID) function that reliably detects when a spell is on cooldown.

Purpose: This function is the detection layer that Phase 3 (Alpha-Based Hiding) will consume. It encapsulates all the complexity of GCD filtering, charge spell handling, and error handling into a single clean boolean API.

Output: BCDM:IsSpellOnCooldown(spellID) function in Core/Globals.lua
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cooldown-state-detection/02-CONTEXT.md
@.planning/phases/02-cooldown-state-detection/02-RESEARCH.md

# BCM codebase patterns (from RESEARCH.md):
@Core/Globals.lua
@Modules/CustomCooldownViewer.lua
@Modules/DisableAuraOverlay.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement IsSpellOnCooldown function</name>
  <files>Core/Globals.lua</files>
  <action>
Add the BCDM:IsSpellOnCooldown(spellID) function to Core/Globals.lua, after the existing HideWhenOffCooldown API functions (after line 613).

Implementation requirements (from CONTEXT.md and RESEARCH.md):

1. **Input validation:**
   - Return false if spellID is nil or 0 (fail-show behavior)
   - Validate spell exists using C_Spell.GetSpellInfo - return false if nil

2. **Charge spell detection (check FIRST):**
   - Call C_Spell.GetSpellCharges(spellID)
   - If returns non-nil table, it's a charge spell
   - Return true if currentCharges < maxCharges (any charge recharging)
   - Return false if currentCharges >= maxCharges (all charges available)

3. **Regular spell cooldown check:**
   - Call C_Spell.GetSpellCooldown(spellID)
   - Return false if cdInfo is nil (API error, fail-show)
   - Filter GCD: if cdInfo.isOnGCD is true, return false (GCD doesn't count)
   - If isOnGCD field is nil, add fallback check: return cdInfo.duration > 1.5 (GCD is typically <= 1.5s)
   - Return true if cdInfo.duration and cdInfo.duration > 0

4. **Error handling philosophy:**
   - Fail-show: On any error or uncertainty, return false (don't hide icon)
   - No pcall needed around GetSpellCharges/GetSpellCooldown - BCM pattern shows these return nil on error, not throw
   - Optional: Log warning via BCDM:PrettyPrint if isOnGCD field missing (helps debug)

Add a comment block above the function documenting:
- Purpose: Check if a spell is on cooldown (for hide-when-off-cooldown feature)
- Returns: true = on cooldown (show icon), false = off cooldown or error (hide icon or fail-show)
- Note about GCD filtering and charge spell handling
  </action>
  <verify>
Run grep to confirm function exists:
```
grep -n "function BCDM:IsSpellOnCooldown" Core/Globals.lua
```
Expected: One match showing the function definition

Run grep to confirm charge spell check exists:
```
grep -n "GetSpellCharges" Core/Globals.lua
```
Expected: At least one match in the new function

Run grep to confirm GCD filtering exists:
```
grep -n "isOnGCD" Core/Globals.lua
```
Expected: At least one match checking isOnGCD field
  </verify>
  <done>
- BCDM:IsSpellOnCooldown(spellID) function exists in Core/Globals.lua
- Function checks charge spells first (GetSpellCharges)
- Function filters GCD-only states (isOnGCD check)
- Function returns false on errors/invalid IDs (fail-show)
- Comment block documents function purpose and behavior
  </done>
</task>

</tasks>

<verification>
1. Function signature: `grep -n "function BCDM:IsSpellOnCooldown" Core/Globals.lua` shows the function
2. Charge handling: `grep -n "GetSpellCharges" Core/Globals.lua` confirms charge spell detection
3. GCD filtering: `grep -n "isOnGCD" Core/Globals.lua` confirms GCD filtering
4. Error handling: `grep -n "return false" Core/Globals.lua` shows multiple fail-show returns
5. WoW loads without errors: No Lua syntax errors (verified by addon loading in-game in Phase 3)
</verification>

<success_criteria>
- [ ] BCDM:IsSpellOnCooldown(spellID) function added to Core/Globals.lua
- [ ] Function returns true when spell has real cooldown (not GCD)
- [ ] Function returns false when spell is off cooldown or only on GCD
- [ ] Function handles charge spells: true if recharging, false if all charges available
- [ ] Function returns false on invalid/error (fail-show philosophy)
- [ ] All grep verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-cooldown-state-detection/02-01-SUMMARY.md`
</output>
