---
phase: 05-ui-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Core/GUI.lua]
autonomous: true

must_haves:
  truths:
    - "User sees a 'Hide When Off Cooldown' checkbox in Essential bar settings panel"
    - "User sees a 'Hide When Off Cooldown' checkbox in Utility bar settings panel"
    - "Checkbox is unchecked by default (matches Phase 1 default of false)"
    - "Toggling checkbox on instantly hides off-cooldown spell icons"
    - "Toggling checkbox off instantly restores all icons to visible"
    - "No checkbox appears for Custom, Item, ItemSpell, or Trinket bar types"
    - "Hovering the checkbox shows a one-line tooltip"
  artifacts:
    - path: "Core/GUI.lua"
      provides: "HideWhenOffCooldown checkbox in Essential/Utility settings"
      contains: "hideWhenOffCooldownCheckbox"
  key_links:
    - from: "Core/GUI.lua"
      to: "BCDM.db.profile.CooldownManager[viewerType].HideWhenOffCooldown"
      via: "SetValue reads setting, OnValueChanged writes setting"
      pattern: "BCDM\\.db\\.profile\\.CooldownManager\\[viewerType\\]\\.HideWhenOffCooldown"
    - from: "Core/GUI.lua"
      to: "BCDM:RefreshHideWhenOffCooldown()"
      via: "OnValueChanged callback triggers visibility refresh"
      pattern: "BCDM:RefreshHideWhenOffCooldown"
---

<objective>
Add a per-bar "Hide When Off Cooldown" checkbox to the Essential and Utility bar settings panels, completing the feature's user-facing configuration.

Purpose: This is the final phase — all backend infrastructure (settings, cooldown detection, alpha hiding, layout collapse) is complete. Users currently have no way to toggle the feature. This plan exposes the existing setting via a checkbox so users can enable/disable hiding per bar.

Output: A checkbox in the Essential/Utility Settings InlineGroup that toggles HideWhenOffCooldown with instant-apply behavior and a hover tooltip.
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ui-configuration/05-RESEARCH.md
@Core/GUI.lua
@Modules/HideWhenOffCooldown.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HideWhenOffCooldown checkbox to Essential/Utility settings panel</name>
  <files>Core/GUI.lua</files>
  <action>
In Core/GUI.lua, find the `if viewerType == "Essential" or viewerType == "Utility"` block (around line 1658). This block creates a `toggleContainer` InlineGroup and already contains the `centerHorizontallyCheckbox`. Add the HideWhenOffCooldown checkbox AFTER the CenterHorizontally checkbox (after line 1684, before the closing `end` of the if block at line 1685).

Add these lines inside the existing block, after `toggleContainer:AddChild(centerHorizontallyCheckbox)`:

```lua
local hideWhenOffCooldownCheckbox = AG:Create("CheckBox")
hideWhenOffCooldownCheckbox:SetLabel("Hide When Off Cooldown")
hideWhenOffCooldownCheckbox:SetValue(BCDM.db.profile.CooldownManager[viewerType].HideWhenOffCooldown)
hideWhenOffCooldownCheckbox:SetCallback("OnValueChanged", function(_, _, value)
    BCDM.db.profile.CooldownManager[viewerType].HideWhenOffCooldown = value
    BCDM:RefreshHideWhenOffCooldown()
end)
hideWhenOffCooldownCheckbox:SetCallback("OnEnter", function(widget)
    GameTooltip:SetOwner(widget.frame, "ANCHOR_CURSOR")
    GameTooltip:SetText("Hides spell icons that are not on cooldown", 1, 1, 1, 1, false)
    GameTooltip:Show()
end)
hideWhenOffCooldownCheckbox:SetCallback("OnLeave", function() GameTooltip:Hide() end)
hideWhenOffCooldownCheckbox:SetRelativeWidth(1)
toggleContainer:AddChild(hideWhenOffCooldownCheckbox)
```

Key implementation details (per user decisions and research):
- Label: "Hide When Off Cooldown" (locked decision)
- Tooltip: one line only, no mention of layout collapse (locked decision)
- Use `GameTooltip` via OnEnter/OnLeave, NOT `SetDescription` (research pattern 3)
- Use `BCDM:RefreshHideWhenOffCooldown()` NOT `BCDM:UpdateCooldownViewer(viewerType)` (research pitfall 1)
- Add to `toggleContainer` NOT `ScrollFrame` (research pitfall 2)
- Instant-apply via OnValueChanged callback (Claude's discretion: matches existing addon behavior — all settings apply instantly)
- `SetRelativeWidth(1)` for full-width checkbox row
- The conditional `if viewerType == "Essential" or viewerType == "Utility"` block already ensures only supported bars get this checkbox (research pitfall 3)

Do NOT:
- Create a new container or section header (locked decision: inline with existing options)
- Add visual indicators on the bar frame itself (locked decision)
- Use SetDescription (anti-pattern per research)
- Add multi-line or verbose tooltip text (locked decision: one line only)
  </action>
  <verify>
1. `grep -c "hideWhenOffCooldownCheckbox" Core/GUI.lua` returns >= 1
2. `grep -c "RefreshHideWhenOffCooldown" Core/GUI.lua` returns >= 1
3. `grep "Hide When Off Cooldown" Core/GUI.lua` shows the label string
4. `grep "Hides spell icons that are not on cooldown" Core/GUI.lua` shows the tooltip string
5. `grep -A2 "hideWhenOffCooldownCheckbox:SetCallback.*OnValueChanged" Core/GUI.lua` shows it sets the db value and calls RefreshHideWhenOffCooldown
6. `grep -B5 "hideWhenOffCooldownCheckbox" Core/GUI.lua | head -10` confirms the checkbox is inside the Essential/Utility conditional block (not at top level)
7. Verify no `UpdateCooldownViewer` call in the hideWhenOffCooldown callback: `grep -A3 "hideWhenOffCooldownCheckbox.*OnValueChanged" Core/GUI.lua | grep -c "UpdateCooldownViewer"` returns 0
  </verify>
  <done>
- Core/GUI.lua contains a HideWhenOffCooldown checkbox inside the Essential/Utility settings InlineGroup
- Checkbox reads from BCDM.db.profile.CooldownManager[viewerType].HideWhenOffCooldown
- OnValueChanged writes the setting and calls BCDM:RefreshHideWhenOffCooldown()
- OnEnter shows GameTooltip with "Hides spell icons that are not on cooldown"
- OnLeave hides the tooltip
- Checkbox uses SetRelativeWidth(1) for full width
- Checkbox is only rendered for Essential and Utility bar types
  </done>
</task>

</tasks>

<verification>
1. Checkbox appears only in Essential/Utility settings (inside the existing conditional block)
2. Checkbox label is exactly "Hide When Off Cooldown"
3. Tooltip text is a single line describing the feature
4. OnValueChanged callback updates the database AND calls RefreshHideWhenOffCooldown
5. No new containers, separators, or sections added
6. No references to UpdateCooldownViewer in the new code
7. Pattern matches existing CenterHorizontally checkbox style (AG:Create, SetLabel, SetValue, SetCallback, SetRelativeWidth, AddChild)
</verification>

<success_criteria>
- Core/GUI.lua modified with HideWhenOffCooldown checkbox
- Checkbox follows exact same pattern as existing CenterHorizontally checkbox
- All user locked decisions honored: label text, tooltip text, placement, no extra UI elements
- Feature is fully wired: checkbox reads/writes the Phase 1 setting and triggers Phase 3 refresh
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-configuration/05-01-SUMMARY.md`
</output>
