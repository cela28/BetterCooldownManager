---
phase: 03-alpha-based-hiding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Modules/HideWhenOffCooldown.lua
  - Modules/Init.xml
autonomous: true

must_haves:
  truths:
    - "Icon is invisible (alpha=0) when spell is off cooldown and feature enabled"
    - "Icon is visible (alpha=1) when spell is on cooldown"
    - "Feature only affects bars where HideWhenOffCooldown setting is enabled"
    - "All icon elements (texture, cooldown spiral, text) hide together via parent alpha"
    - "Charge spells remain visible while recharging"
  artifacts:
    - path: "Modules/HideWhenOffCooldown.lua"
      provides: "Icon visibility logic based on cooldown state"
      contains: "UpdateIconVisibility"
      min_lines: 60
    - path: "Modules/Init.xml"
      provides: "Module load registration"
      contains: "HideWhenOffCooldown.lua"
  key_links:
    - from: "Modules/HideWhenOffCooldown.lua"
      to: "BCDM:IsSpellOnCooldown"
      via: "function call for cooldown detection"
      pattern: "BCDM:IsSpellOnCooldown"
    - from: "Modules/HideWhenOffCooldown.lua"
      to: "BCDM:IsHideWhenOffCooldownEnabled"
      via: "function call for setting check"
      pattern: "BCDM:IsHideWhenOffCooldownEnabled"
    - from: "Modules/HideWhenOffCooldown.lua"
      to: "EssentialCooldownViewer.RefreshLayout"
      via: "hooksecurefunc for layout updates"
      pattern: "hooksecurefunc.*RefreshLayout"
---

<objective>
Implement alpha-based icon hiding for spells that are off cooldown on Essential and Utility bars.

Purpose: This is the core visibility feature - icons disappear when their spell is ready and reappear when on cooldown, reducing visual clutter.

Output: New HideWhenOffCooldown.lua module that hooks into Blizzard's RefreshLayout and cooldown events to toggle icon visibility.
</objective>

<execution_context>
@/home/sntanavaras/.claude/get-shit-done/workflows/execute-plan.md
@/home/sntanavaras/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-alpha-based-hiding/03-RESEARCH.md

# Phase 1 and 2 summaries - provides APIs we consume
@.planning/phases/01-settings-infrastructure/01-01-SUMMARY.md
@.planning/phases/02-cooldown-state-detection/02-01-SUMMARY.md

# Existing BCM patterns to follow
@Modules/DisableAuraOverlay.lua
@Modules/CooldownManager.lua
@Core/Globals.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HideWhenOffCooldown module</name>
  <files>Modules/HideWhenOffCooldown.lua</files>
  <action>
Create a new module `Modules/HideWhenOffCooldown.lua` that implements icon visibility toggling based on cooldown state.

**Module structure (follow DisableAuraOverlay.lua pattern):**

1. **Local variables at top:**
   - `local _, BCDM = ...`
   - `local isEnabled = false`
   - `local eventFrame = nil`
   - `local VIEWERS = { "EssentialCooldownViewer", "UtilityCooldownViewer" }`

2. **GetSpellID helper function:**
   - Copy pattern from DisableAuraOverlay.lua lines 40-42
   - Returns `info.overrideSpellID or info.spellID` from frame.cooldownInfo

3. **UpdateIconVisibility(viewerName) function:**
   - Get viewer from `_G[viewerName]`
   - Return early if viewer nil
   - Check `BCDM:IsHideWhenOffCooldownEnabled(viewerName)` - if false, restore all icons to alpha=1 and return
   - Iterate viewer children: `for _, icon in ipairs({ viewer:GetChildren() }) do`
   - For each icon with cooldownInfo:
     - Get spellID via GetSpellID(icon)
     - If spellID valid: call `BCDM:IsSpellOnCooldown(spellID)`
     - Set `icon:SetAlpha(isOnCooldown and 1 or 0)`
     - If spellID invalid: fail-show with `icon:SetAlpha(1)`

4. **UpdateAllViewers() function:**
   - Loop through VIEWERS table
   - Call UpdateIconVisibility for each

5. **SetupRefreshLayoutHooks() function:**
   - For each viewer in VIEWERS:
     - Check if viewer exists and has RefreshLayout method
     - `hooksecurefunc(viewer, "RefreshLayout", function() UpdateIconVisibility(viewerName) end)`

6. **SetupEventFrame() function:**
   - Create frame: `eventFrame = CreateFrame("Frame", "BCDM_HideWhenOffCooldownFrame")`
   - Register events: SPELL_UPDATE_COOLDOWN, SPELL_UPDATE_CHARGES, PLAYER_ENTERING_WORLD, PLAYER_SPECIALIZATION_CHANGED
   - SetScript OnEvent: call UpdateAllViewers()

7. **BCDM:EnableHideWhenOffCooldown() function:**
   - Set isEnabled = true
   - Call SetupEventFrame()
   - Call SetupRefreshLayoutHooks()
   - Call UpdateAllViewers() for initial state

8. **BCDM:DisableHideWhenOffCooldown() function:**
   - Set isEnabled = false
   - Unregister all events from eventFrame
   - Restore all icons to alpha=1

9. **BCDM:RefreshHideWhenOffCooldown() function:**
   - Called when settings change
   - Calls UpdateAllViewers()

**Key implementation details:**
- Always use parent frame SetAlpha (not child elements)
- Follow fail-show pattern: return alpha=1 on any error
- Guard against nil viewer, nil cooldownInfo, nil spellID
- No OnUpdate polling - rely on events + RefreshLayout hooks only
  </action>
  <verify>
1. File exists: `ls Modules/HideWhenOffCooldown.lua`
2. Contains UpdateIconVisibility function: `grep -c "UpdateIconVisibility" Modules/HideWhenOffCooldown.lua` returns >= 1
3. Contains BCDM:IsSpellOnCooldown call: `grep -c "BCDM:IsSpellOnCooldown" Modules/HideWhenOffCooldown.lua` returns >= 1
4. Contains BCDM:IsHideWhenOffCooldownEnabled call: `grep -c "BCDM:IsHideWhenOffCooldownEnabled" Modules/HideWhenOffCooldown.lua` returns >= 1
5. Contains RefreshLayout hook: `grep -c "RefreshLayout" Modules/HideWhenOffCooldown.lua` returns >= 1
6. Contains SetAlpha call: `grep -c "SetAlpha" Modules/HideWhenOffCooldown.lua` returns >= 1
  </verify>
  <done>
HideWhenOffCooldown.lua exists with:
- UpdateIconVisibility function that iterates viewer children
- Calls BCDM:IsSpellOnCooldown for cooldown detection
- Calls BCDM:IsHideWhenOffCooldownEnabled for setting check
- Hooks into RefreshLayout on Essential and Utility viewers
- Registers for SPELL_UPDATE_COOLDOWN and SPELL_UPDATE_CHARGES events
- Sets icon alpha to 0 when off cooldown, 1 when on cooldown
  </done>
</task>

<task type="auto">
  <name>Task 2: Register module and wire initialization</name>
  <files>Modules/Init.xml, Modules/CooldownManager.lua</files>
  <action>
**Part A: Add module to Init.xml**

In `Modules/Init.xml`, add the new script file after DisableAuraOverlay.lua:

```xml
<Script file="DisableAuraOverlay.lua"/>
<Script file="HideWhenOffCooldown.lua"/>
```

Place after DisableAuraOverlay.lua since both deal with icon appearance manipulation.

**Part B: Wire initialization in CooldownManager.lua**

In `BCDM:SkinCooldownManager()` function (around line 377-397), add initialization call after the existing RefreshLayout hooks are set up (after line 387):

```lua
-- After the existing RefreshLayout hooks for centering (lines 386-387)
if EssentialCooldownViewer and EssentialCooldownViewer.RefreshLayout then hooksecurefunc(EssentialCooldownViewer, "RefreshLayout", function() CenterWrappedIcons() end) end
if UtilityCooldownViewer and UtilityCooldownViewer.RefreshLayout then hooksecurefunc(UtilityCooldownViewer, "RefreshLayout", function() CenterWrappedIcons() end) end

-- Add this line to initialize HideWhenOffCooldown
BCDM:EnableHideWhenOffCooldown()
```

**Why wire it here:**
- SkinCooldownManager is called during addon initialization
- RefreshLayout hooks must be set up after viewers exist
- This is the same pattern used for centering functionality
  </action>
  <verify>
1. Init.xml contains HideWhenOffCooldown.lua: `grep -c "HideWhenOffCooldown.lua" Modules/Init.xml` returns 1
2. CooldownManager.lua calls EnableHideWhenOffCooldown: `grep -c "EnableHideWhenOffCooldown" Modules/CooldownManager.lua` returns >= 1
  </verify>
  <done>
- Init.xml loads HideWhenOffCooldown.lua module
- CooldownManager.lua calls BCDM:EnableHideWhenOffCooldown() during initialization
- Module is active when addon loads
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Structural verification:**
   - `ls Modules/HideWhenOffCooldown.lua` - file exists
   - `grep "HideWhenOffCooldown" Modules/Init.xml` - module registered
   - `grep "EnableHideWhenOffCooldown" Modules/CooldownManager.lua` - init wired

2. **Code pattern verification:**
   - `grep "IsSpellOnCooldown" Modules/HideWhenOffCooldown.lua` - uses Phase 2 API
   - `grep "IsHideWhenOffCooldownEnabled" Modules/HideWhenOffCooldown.lua` - uses Phase 1 API
   - `grep "SetAlpha" Modules/HideWhenOffCooldown.lua` - implements visibility toggle
   - `grep "RefreshLayout" Modules/HideWhenOffCooldown.lua` - hooks into Blizzard updates
   - `grep "SPELL_UPDATE_COOLDOWN" Modules/HideWhenOffCooldown.lua` - registers events

3. **No syntax errors:**
   - No Lua syntax check available without WoW runtime, but code should follow BCM conventions
</verification>

<success_criteria>
- [ ] HideWhenOffCooldown.lua module created with correct structure
- [ ] Module uses BCDM:IsSpellOnCooldown from Phase 2
- [ ] Module uses BCDM:IsHideWhenOffCooldownEnabled from Phase 1
- [ ] Module hooks into RefreshLayout on Essential and Utility viewers
- [ ] Module registers for SPELL_UPDATE_COOLDOWN and SPELL_UPDATE_CHARGES events
- [ ] Module sets icon alpha based on cooldown state
- [ ] Module registered in Init.xml
- [ ] Module initialization wired in CooldownManager.lua
</success_criteria>

<output>
After completion, create `.planning/phases/03-alpha-based-hiding/03-01-SUMMARY.md`
</output>
